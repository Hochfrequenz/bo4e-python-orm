[tox]
envlist =
    integrationtests
    unittests
    linting
    coverage
    type_check
skip_missing_interpreters = True
skipsdist = True

[testenv]
#basepython = py312
commands = python -m pip install --upgrade pip

[testenv:unittests]
# the tests environment is called by the Github action that runs the unit tests
deps =
    -r requirements.txt
    -r dev_requirements/requirements-tests.txt
setenv = PYTHONPATH = {toxinidir}/src
commands =
    tox -e setup_testpostgresql
    tox -e remove_testpostgresql
allowlist_externals =
    tox
[testenv:integrationtests]
# the tests environment is called by the Github action that runs the unit tests
deps =
    -r requirements.txt
    -r dev_requirements/requirements-tests.txt
setenv = PYTHONPATH = {toxinidir}/src
commands =
    tox -e setup_bo4e
    python -m borm
    #tox -e migration
    python -m pytest --basetemp={envtmpdir} {posargs}
    tox -e remove_testpostgresql
allowlist_externals =
    tox


[testenv:linting]
# the linting environment is called by the Github Action that runs the linter
deps =
    {[testenv:integrationtests]deps}
    {[testenv:unittests]deps}
    -r dev_requirements/requirements-linting.txt
setenv = PYTHONPATH = {toxinidir}/src
commands =
    tox -e init_bo4e
    pylint src/borm --disable R0801 --ignore-paths 'src/borm/models'
    #run for the code generated files
    #know things to be fixed:
    #docstrings for generated code
    #unused imports
    #lines in comments too long
    #too many lines -> many-many relationship classes
    pylint src/borm/models --disable R0801,C0114,C0115,W0611,C0301,C0302
    pylint tests --rcfile=tests/.pylintrc
allowlist_externals =
    tox

[testenv:type_check]
# the type_check environment checks the type hints using mypy
setenv = PYTHONPATH = {toxinidir}/src
deps =
    -r requirements.txt
    -r dev_requirements/requirements-type_check.txt
    -r dev_requirements/requirements-tests.txt
commands =
    tox -e init_bo4e
    mypy --show-error-codes tests
    mypy --show-error-codes src/borm
allowlist_externals =
    tox

[testenv:spell_check]
# the spellcheck environment checks the code for typos
setenv = PYTHONPATH = {toxinidir}/src
deps =
    -r requirements.txt
    -r dev_requirements/requirements-spell_check.txt
commands =
    codespell --ignore-words=domain-specific-terms.txt src/
    codespell --ignore-words=domain-specific-terms.txt README.md

[testenv:coverage]
# the coverage environment is called by the Github Action that runs the coverage measurement
changedir = tests
deps =
    {[testenv:integrationtests]deps}
    {[testenv:unittests]deps}
    -r dev_requirements/requirements-coverage.txt
setenv = PYTHONPATH = {toxinidir}/src
commands =
    tox -e setup_bo4e
    python -m borm
    coverage run -m pytest --basetemp={envtmpdir} {posargs}
    coverage html --omit .tox/*,tests/*,src/borm/models/*
    coverage report --fail-under 80 --omit .tox/*,tests/*,src/borm/models/*
    tox -e remove_testpostgresql
allowlist_externals =
    tox

[testenv:setup_testpostgresql]
# Setting up a postgresql database for testing
changedir = src
deps =
    -rrequirements.txt
commands =
    python -m borm.db.postgresql_db.create_env_file
    docker-compose -f "borm/db/postgresql_db/docker-compose.yaml" up -d
allowlist_externals =
    docker-compose

[testenv:init_bo4e]
# creating SQLModel for bo4e
deps =
    -rrequirements.txt
    BO4E-Schema-Tool @ git+https://github.com/bo4e/BO4E-Schema-Tool.git
    BO4E-Python-Generator @ git+https://github.com/bo4e/BO4E-Python-Generator.git@DDB/create_SQLModels
commands =
    bost -t v0.6.1-rc14 -o bo4e_schemas/output
    bo4e-generator -i bo4e_schemas/output -o src/borm/models -ot sql_model
allowlist_externals =
    BO4E-Schema-Tool
    BO4E-Python-Generator

[testenv:setup_bo4e]
# Setting up a postgresql database with bo4e
deps =
    -rrequirements.txt
commands =
    tox -e setup_testpostgresql
    tox -e init_bo4e
allowlist_externals =
    tox

[testenv:remove_testpostgresql]
# removing up a postgresql database for testing
changedir = src/borm/db/postgresql_db
deps =
    -rrequirements.txt
commands =
    docker-compose -f "docker-compose.yaml" down -v
allowlist_externals =
    docker-compose

[testenv:migration]
# I created this environment for github CI because when doing docker-compose the environment doesn't know migrations and
# all its dependencies and therefore skips it during building.
# This environment just applies the revisions to the database (after docker-compose).
changedir = src/borm/db/postgresql_db
deps =
    -rrequirements.txt
commands =
    alembic upgrade head
allowlist_externals =
    alembic


[testenv:dev]
# the dev environment contains everything you need to start developing on your local machine.
deps =
    {[testenv:integrationtests]deps}
    {[testenv:unittests]deps}
    {[testenv:linting]deps}
    {[testenv:type_check]deps}
    {[testenv:coverage]deps}
    {[testenv:spell_check]deps}
    {[testenv:setup_testpostgresql]deps}
    {[testenv:remove_testpostgresql]deps}
    -r dev_requirements/requirements-formatting.txt
    pip-tools
    pre-commit
commands =
    python -m pip install --upgrade pip
    pip-compile requirements.in
    pip-compile dev_requirements/requirements-coverage.in
    pip-compile dev_requirements/requirements-formatting.in
    pip-compile dev_requirements/requirements-linting.in
    pip-compile dev_requirements/requirements-packaging.in
    pip-compile dev_requirements/requirements-spell_check.in
    pip-compile dev_requirements/requirements-tests.in
    pip-compile dev_requirements/requirements-type_check.in
    pip install -r requirements.txt
    pre-commit install

[testenv:test_packaging]
skip_install = true
deps =
    -r dev_requirements/requirements-packaging.txt
commands =
    python -m build
    twine check dist/*
